## 単一テーブル継承（Single Table Inheritance, STI）とは
同じカラム設計のテーブルを1つにまとめることで余計なテーブルを増やさず、DRYなテーブル設計にするというデザインパターン。<br/>
クラス間で用いられる「継承」の仕組みをDB（テーブル設計）にも適用しようという考え方。<br/>

親モデルを継承した子モデルを作成し、子モデルのレコードは親モデルに対応したテーブルに保存する。<br/>
こうすることで、同じカラム設計のテーブルを子モデルの数だけ用意するのではなく、1つのテーブルにまとめることが可能。<br/>
また、子モデルに対応するテーブルは存在しないが、コードを書く上ではそれぞれに対応するテーブルが疑似的に存在するかのように扱うことができる。


※ **DRY原則**<br/>
「Don't Repeat Yourself」の略。<br/>
ソフトウェアの構成や構築手法についての原則の一つで、同じ意味や機能を持つ情報を複数の場所に重複して置くことをなるべく避けるべきとする考え方。

※ **継承**<br/>
各クラスの共通項目が括りだされたスーパークラスと、非共通項目のサブクラスを用いることでコードの重複を防ぐ仕組み。

### STIの意義
STIの主な意義は、データベース内での冗長性を減少させ、コードの再利用性を高めること。
- メリット
1. データベースの冗長性の削減
   
複数のモデルが共通の属性を持つ場合、それぞれのモデルに対応するテーブルを別々に作成する代わりに、STIを使用して一つのテーブルで管理できる。<br/>
これにより、冗長なデータ構造を避けることが可能。

2. コードの再利用
   
共通の属性や振る舞いを持つ複数のモデルがある場合、STIを使用することでコードが重複せずに済むため、メンテナンスが容易になる。

3. クエリの簡素化

共通の属性を持つ複数のモデルを一つのテーブルにまとめることで、データベースクエリが単純化され、検索や結合などの操作が効率的に行える。

- デメリット
  
1. テーブルのカラム増加

異なるモデル間でのカラムの差異が大きい場合、単一のテーブル内に多くのカラムが存在する可能性がある。<br/>
これによりテーブルが複雑化し、一部のカラムは他のモデルには関係のないものとなることがある。

2. カラムの冗長性

カラムのうち一部は、特定のモデルには適用されないものが含まれる可能性がある。<br/>
そのため、DB内には不要なカラムが存在し、冗長性が発生することがある。

3. 継承の複雑性

STIを使用する際、継承関係やデータのバリデーションなど、クラス間の関係性を適切に管理する必要があり、これが複雑になる場合がある。


### 実装方法
1. ベースとなる親モデルを作成する
   
Carモデル、Motorcycleモデル、BicycleモデルのベースとしてVehicleモデルを作る。
```ruby
$ rails generate model vehicle type:string color:string price:decimal{10.2}

# price:decimal{10.2}は、合計の桁数が10で、小数点以下は最大2桁という形でdecimal型の精度を指定している
```
`type`カラムを定義しておくことに注意。<br/>
ここに「どの子モデルのレコードか」という情報を保持する。<br/>
また、子モデルのいずれかに特有のカラムがある場合は、ベースとなる親モデルにも定義しておく必要がある。

<br/>

2. 子モデルを作成する
   
```ruby
$ rails generate model car --parent=Vehicle
```
`--parent=親モデル`オプションを使って特定の親モデルを継承したモデルを作る。<br/>
このオプションを使うと、同様のマイグレーションファイルを生成せずにモデルを生成できる（該当するテーブルが既に存在しているため）。<br/>

生成されるモデルは以下:
```ruby
class Car < Vehicle
end
```
<br/>

3. 子モデルのレコードを保存する
   
この状態で新しく作成した`Car`インスタンスを保存すると、`type`カラムに`Car`が代入されたレコードが`vehicles`テーブルに追加される。

### まとめ
1. ベースとなる親モデルとテーブルを作成する
2. 親モデルを継承した子モデルを作成する
3. 子モデルのインスタンスは親モデルのテーブルに保存され、親モデルの`type`カラムに「どの子モデルか」という情報が保持される

|  | 親モデル | 親テーブル| 子モデル | 子テーブル |
| --- | --- | --- | --- | --- |
| 存在 | する | する | する | しない |

### 参考文献
- [Railsガイド ActiveRecordの関連付け STI](https://railsguides.jp/association_basics.html#%E5%8D%98%E4%B8%80%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E7%B6%99%E6%89%BF-%EF%BC%88sti%EF%BC%89)
- [単一テーブル継承](https://takuya178.hatenablog.com/entry/2021/06/16/232310)
- [【Rails】単一テーブル継承(STI)について](https://qiita.com/niwa1903/items/218713c076fb0075712f)
- [みんなRailsのSTIを誤解してないか!?](https://qiita.com/yebihara/items/9ecb838893ad99be0561)
- ChatGPT: STIの意義とメリット・デメリットについて
